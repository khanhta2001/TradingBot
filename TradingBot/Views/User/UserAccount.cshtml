@model TradingBotAPI.Models.Account
@{
    Layout = "_Layout";
}

<div class="container mt-5">
    <div>
        <h2>Welcome, @Model.UserName!</h2>
    </div>
        <div class="mb-3 d-flex justify-content-end">
            <button id="editButton" class="btn btn-primary">Edit</button>
        </div>
    <form method="post" action="@Url.Action("EditConsumerDetails", "User")">
        <table class="table">
            <tbody>
                <tr>
                    <td>Consumer Key</td>
                    <td>
                        @if (string.IsNullOrEmpty(Model.ConnectionAuth.ConsumerKey) || Model.ConnectionAuth.ConsumerKey == "None")
                        {
                            <span id="consumerKeySpan">Not Set</span>
                        }
                        else
                        {
                            <span id="consumerKeySpan">@Model.ConnectionAuth.ConsumerKey</span>
                        }
                        <input type="text" id="consumerKeyInput" name="ConsumerKey" value="@Model.ConnectionAuth.ConsumerKey" style="display: none;" />
                    </td>
                </tr>
                <tr>
                    <td>Consumer Secret</td>
                    <td>
                        @if (string.IsNullOrEmpty(Model.ConnectionAuth.ConsumerSecret) || Model.ConnectionAuth.ConsumerSecret == "None")
                        {
                            <span id="consumerSecretSpan">Not Set</span>
                        }
                        else
                        {
                            <span id="consumerSecretSpan">@Model.ConnectionAuth.ConsumerSecret</span>
                        }
                        <input type="text" id="consumerSecretInput" name="ConsumerSecret" value="@Model.ConnectionAuth.ConsumerSecret" style="display: none;" />
                    </td>
                </tr>
            </tbody>
        </table>
        <div class="mt-3">
            <input type="hidden" name="userName" value="@Model.UserName"/>
            <button type="submit" id="submitButton" style="display: none;" class="btn btn-success">Submit</button>
        </div>
    </form>
</div>

<script>
    $(document).ready(function () {
            $("#editButton").click(function () {
                $(this).hide();
                $("#consumerKeySpan, #consumerSecretSpan").hide();
                $("#consumerKeyInput, #consumerSecretInput, #submitButton").show();
            });
        });
    
    $("#submitButton").click(function(e){
        e.preventDefault();
    
        var url = "@Url.Action("EditConsumerDetails", "User")"; 
    
        $.ajax({
            type: "POST",
            url: url,
            data: {
                ConsumerKey: $("#consumerKeyInput").val(),
                ConsumerSecret: $("#consumerSecretInput").val(),
                UserName: $("input[name='userName']").val()
            },
            success: function(response){
                showAuthPopup(response.authorizationUrl);
            },
            error: function(error){
                console.error("Error occurred:", error);
            }
        });
    });
    function showAuthPopup(authorizationUrl){
        var popupContent = `
            <div>
                <p>Click the link below to get your verification code:</p>
                <a href="${authorizationUrl}" target="_blank">Authorization Link</a>
                <br/>
                <input type="text" id="verificationCode" placeholder="Enter verification code here" />
                <button id="verifyButton">Verify</button>
            </div>
        `;
    
        // Assuming you use Bootstrap's modal
        var popup = `
            <div class="modal" tabindex="-1" role="dialog" id="authPopup">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Authorization</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            ${popupContent}
                        </div>
                    </div>
                </div>
            </div>
        `;
    
        $("body").append(popup);
        $("#authPopup").modal('show');
    }
    
    $(document).on("click", "#verifyButton", function(){
        var verificationCode = $("#verificationCode").val();
    
        var verifyUrl = "@Url.Action("VerifyCode", "User")";  // Replace "VerifyCodeMethod" with the name of your verification method
    
        $.ajax({
            type: "POST",
            url: verifyUrl,
            data: {
                VerificationCode: verificationCode
            },
            success: function(response){
                if(response.verified) {  // Assuming the response contains a 'verified' boolean
                    alert("Successfully verified!");  // You can replace this with a more elegant notification
                } else {
                    alert("Verification failed. Please try again.");
                }
            },
            error: function(error){
                console.error("Error occurred:", error);
            }
        });
    });

</script>
